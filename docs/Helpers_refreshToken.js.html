<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Helpers/refreshToken.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Helpers/refreshToken.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @deprecated Superagent should no longer be used
 */
const superagent = require('superagent');
require('dotenv').config();
fs = require('fs');

/**
 * HTTP request body contains the credentials from the .env
 * @type {{client_id : string , client_secret : string , audience: string, grant_type: string}}
 */
const body = {client_id : `${process.env.CLIENT_ID}` ,client_secret :`${process.env.CLIENT_SECRET}`,audience:"https://dev-5zxjin17.eu.auth0.com/api/v2/",grant_type:"client_credentials"}


function refreshToken(_callback) {
    
    checkLocalToken((token)=>{
            if (token!==undefined) {
                _callback(token)                
            }
            else{
                superagent.post(`${process.env.ISSUER_BASE_URL}/oauth/token`)
                .set('content-type', 'application/json')
                .send(body)
                .end((err, res) => {
                        if (err) {
                        console.log(err)
                        }
                        else{
                            let output = JSON.parse(res.text)
                            storeLocalToken(output)
                           _callback(output.access_token)
                        }
                })
            }
    })
}
/**
 * load cookie containing current access_token from root folder
 * @param {function} _callback 
 * @deprecated this is only called by superagent. You should use auth0. (See: {@link auth0})
 */
function checkLocalToken(_callback){
    var token = JSON.parse(fs.readFileSync('storedtoken', 'utf8'));
    var expireDate = new Date(parseInt(token.expires_in)+parseInt(token.dateStored))
    if (expireDate > new Date() ) {
        _callback(token.access_token)    
    }
   _callback()
}

/**
 * save cookie containing current access_token locally 
 * @param {json} output 
 * @deprecated this is only called by superagent
 */
function storeLocalToken(output){
    var tokenDetails = `{"access_token" : "${output.access_token}", "dateStored" : "${Date.now()}", "expires_in" : "${output.expires_in}"}`
    fs.writeFile('storedtoken', tokenDetails, function (err) {
        if (err) {
             console.log(err);
        }

     });
}

module.exports = refreshToken</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Documentation</a></h2><h3>Classes</h3><ul><li><a href="User.html">User</a></li><li><a href="user_.html">user</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addTestUsers">addTestUsers</a></li><li><a href="global.html#auth0">auth0</a></li><li><a href="global.html#auth0CreateUsers">auth0CreateUsers</a></li><li><a href="global.html#body">body</a></li><li><a href="global.html#checkLocalToken">checkLocalToken</a></li><li><a href="global.html#deleteTestUsers">deleteTestUsers</a></li><li><a href="global.html#getAllUsers">getAllUsers</a></li><li><a href="global.html#searchUsers">searchUsers</a></li><li><a href="global.html#setupUsers">setupUsers</a></li><li><a href="global.html#storeLocalToken">storeLocalToken</a></li><li><a href="global.html#superagent">superagent</a></li><li><a href="global.html#teardownUsers">teardownUsers</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.7</a> on Sun Jul 25 2021 17:29:33 GMT+0100 (British Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
